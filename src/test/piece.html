<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contr√¥le - Pi√®ce</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      width: 90%;
      max-width: 1200px;
      background-color: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #FF6600;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      border-bottom: 3px solid #FF9933;
      padding-bottom: 15px;
    }

    h2 {
      color: #CC6600;
      font-size: 1.6em;
      margin-top: 30px;
      margin-bottom: 15px;
      padding-left: 10px;
      border-left: 5px solid #FF9933;
    }

    .device-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .control-tile {
      width: 200px;
      height: 130px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      text-align: center;
      transition: all 0.25s ease-in-out;
    }

    .control-tile:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .control-tile i {
      font-size: 2.8em;
      margin-bottom: 8px;
    }

    .light-on { background-color: #FF6600; }
    .light-off { background-color: #bfbfbf; color: #333; }

    .store-open { background-color: #2ecc71; }
    .store-closed { background-color: #bfbfbf; color: #333; }

    .clim-on { background-color: #2ecc71; }
    .clim-off { background-color: #bfbfbf; color: #333; }
    .clim-heat { background-color: #e74c3c; }
    .clim-cool { background-color: #3498db; }

    .clim-buttons {
      display: flex;
      justify-content: space-around;
      width: 100%;
      margin-top: 10px;
    }

    .clim-buttons div {
      flex: 1;
      text-align: center;
      cursor: pointer;
      font-size: 0.85em;
      padding: 4px 0;
      border-radius: 6px;
      transition: background-color 0.2s;
    }

    .clim-buttons div:hover {
      background-color: rgba(255, 255, 255, 0.25);
    }

    .back-button {
      display: inline-block;
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #333;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      transition: background-color 0.3s;
    }

    .back-button:hover { background-color: #000; }
  </style>
</head>

<body>
<div class="container">
  <h1 id="page-title"><i class="fa-solid fa-house"></i> Contr√¥le de la Pi√®ce</h1>
  <div id="controls-container"></div>
  <a href="index.html" class="back-button"><i class="fa-solid fa-arrow-left"></i> Retour aux Pi√®ces</a>
</div>

<script>
  const DEVICE_TYPES = {
    lamps: { title: "Lumi√®res", icon: "fa-lightbulb" },
    store: { title: "Volets Roulants", icon: "fa-house-chimney-window" },
    clim: { title: "Climatisation", icon: "fa-snowflake" }
  };

  const urlParams = new URLSearchParams(window.location.search);
  const rawRoomName = urlParams.get('room')?.trim() || '';

  function normalizeName(name) {
    return name.toLowerCase()
      .replace(/_/g, ' ')
      .replace(/-/g, ' ')
      .replace(/\s+/g, '')
      .normalize("NFD").replace(/[\u0300-\u036f]/g, '');
  }

  const normalizedRoom = normalizeName(rawRoomName);
  document.title = `Contr√¥le - ${rawRoomName}`;
  document.getElementById("page-title").innerHTML = `<i class="fa-solid fa-house"></i> Contr√¥le de ${rawRoomName}`;

  async function loadDevices() {
    try {
      const response = await fetch("../devices.json");
      if (!response.ok) throw new Error("Erreur de chargement du JSON");
      const data = await response.json();
      return data;
    } catch (err) {
      console.error("‚ùå Erreur chargement JSON :", err);
      return {};
    }
  }

  let DEVICES_JSON_DATA = {};

  document.addEventListener("DOMContentLoaded", async () => {
    DEVICES_JSON_DATA = await loadDevices();
    generateControls();
  });

  function generateControls() {
    const container = document.getElementById('controls-container');
    container.innerHTML = '';

    if (!rawRoomName) {
      container.innerHTML = "<p>‚ö†Ô∏è Aucune pi√®ce sp√©cifi√©e dans l‚ÄôURL.</p>";
      return;
    }

    for (const typeKey in DEVICES_JSON_DATA) {
      const typeInfo = DEVICE_TYPES[typeKey];
      const devices = DEVICES_JSON_DATA[typeKey];
      if (!typeInfo || !devices) continue;

      const deviceNames = Object.keys(devices).filter(deviceName => {
        const deviceRoom = deviceName.split(' - ')[0];
        const normalizedDevice = normalizeName(deviceRoom);

        if (normalizedRoom === 'chambrene') {
          return (normalizedDevice === 'chambrene' || normalizedDevice === 'chambrenordest');
        }
        if (normalizedRoom === 'chambreso') {
          return (normalizedDevice === 'chambreso' || normalizedDevice === 'chambresudouest');
        }
        return normalizedDevice === normalizedRoom;
      });

      if (deviceNames.length === 0) continue;

      const h2 = document.createElement('h2');
      h2.innerHTML = `<i class="fa-solid ${typeInfo.icon}"></i> ${typeInfo.title}`;
      container.appendChild(h2);

      const grid = document.createElement('div');
      grid.className = 'device-grid';

      deviceNames.forEach(deviceName => {
        const deviceData = devices[deviceName];
        const tile = createDeviceTile(typeKey, typeInfo, deviceName, deviceData);
        grid.appendChild(tile);
      });

      container.appendChild(grid);
      container.appendChild(document.createElement('hr'));
    }

    const hrs = container.querySelectorAll('hr');
    if (hrs.length > 0) container.removeChild(hrs[hrs.length - 1]);
  }

  function createDeviceTile(typeKey, typeInfo, deviceName, deviceData) {
    const tile = document.createElement('div');
    const shortName = deviceName.split(' - ')[1] || deviceName;

    if (typeKey === 'clim') {
      const initialClass = getClimClass(deviceData.mode, deviceData.state);
      tile.className = `control-tile ${initialClass}`;
      tile.innerHTML = `<i class="fa-solid ${typeInfo.icon}"></i><span>${shortName}</span>`;

      const btnContainer = document.createElement('div');
      btnContainer.className = 'clim-buttons';
      const actions = [
        { label: 'ON', action: 'on' },
        { label: 'OFF', action: 'off' },
        { label: 'CHAUD', action: 'heat' },
        { label: 'FROID', action: 'cool' }
      ];

      actions.forEach(btnInfo => {
        const div = document.createElement('div');
        div.textContent = btnInfo.label;
        div.addEventListener('click', (e) => {
          e.stopPropagation();
          console.log(`üî• Clic CLIM ‚Üí ${deviceName} | Action = ${btnInfo.action}`);
          sendClimCommand(deviceName, btnInfo.action, tile);
        });
        btnContainer.appendChild(div);
      });

      tile.appendChild(btnContainer);
      return tile;
    }

    let displayState = getDisplayState(typeKey, deviceData.state);
    let cssClass = getCssClass(typeKey, deviceData.state);

    tile.className = `control-tile ${cssClass}`;
    tile.innerHTML = `<i class="fa-solid ${typeInfo.icon}"></i><span>${shortName} (${displayState})</span>`;

    tile.addEventListener('click', () => {
      const nextAction = deviceData.state === 'ON' ? 'off' : 'on';
      console.log(`üí° Clic ${typeKey.toUpperCase()} ‚Üí ${deviceName} | Action = ${nextAction}`);
      sendDeviceCommand(typeKey, deviceName, nextAction, tile, deviceData);
    });

    return tile;
  }

  function sendDeviceCommand(typeKey, deviceName, action, tile, deviceData) {
    let cgi = (typeKey === 'lamps') ? 'lampe.exe' : 'store.exe';
    const url = `/cgi-bin/${cgi}?device=${encodeURIComponent(deviceName)}&action=${action}`;
    console.log(`‚û°Ô∏è Envoi CGI : ${url}`);

    fetch(url)
      .then(r => {
        console.log(`‚úÖ R√©ponse HTTP : ${r.status}`);
        return r.text();
      })
      .then(() => {
        deviceData.state = (action === 'on') ? 'ON' : 'OFF';
        updateTileVisual(tile, typeKey, deviceName, deviceData);
        console.log(`üîÑ √âtat mis √† jour ‚Üí ${deviceName} = ${deviceData.state}`);
      })
      .catch(err => console.error("‚ùå Erreur CGI :", err));
  }

  async function sendClimCommand(deviceName, action, tile) {
    const url = `/cgi-bin/clim.exe?device=${encodeURIComponent(deviceName)}&action=${action}`;
    console.log(`üå¨Ô∏è Envoi commande CLIM : ${url}`);
    try {
      const response = await fetch(url);
      console.log(`‚úÖ R√©ponse CLIM HTTP : ${response.status}`);
      const updatedData = await loadDevices();
      const climData = updatedData.clim?.[deviceName];

      if (climData) {
        const newClass = getClimClass(climData.mode, climData.state);
        tile.className = `control-tile ${newClass}`;
        console.log(`‚ôªÔ∏è Nouvelle couleur CLIM : mode=${climData.mode}, √©tat=${climData.state}`);
      }
    } catch (err) {
      console.error("‚ùå Erreur CLIM :", err);
    }
  }

  function updateTileVisual(tile, typeKey, deviceName, deviceData) {
    const shortName = deviceName.split(' - ')[1] || deviceName;
    const displayState = getDisplayState(typeKey, deviceData.state);
    const cssClass = getCssClass(typeKey, deviceData.state);
    const icon = DEVICE_TYPES[typeKey].icon;
    tile.className = `control-tile ${cssClass}`;
    tile.innerHTML = `<i class="fa-solid ${icon}"></i><span>${shortName} (${displayState})</span>`;
  }

  function getDisplayState(typeKey, state) {
    if (typeKey === 'store') return state === 'ON' ? 'OUVERT' : 'FERM√â';
    return state;
  }

  function getCssClass(typeKey, state) {
    if (typeKey === 'lamps') return state === 'ON' ? 'light-on' : 'light-off';
    if (typeKey === 'store') return state === 'ON' ? 'store-open' : 'store-closed';
    return '';
  }

  function getClimClass(mode, state) {
    if (state === 'OFF') return 'clim-off';
    if (mode === 1) return 'clim-heat';
    if (mode === 2) return 'clim-cool';
    return 'clim-on';
  }
</script>
</body>
</html>
