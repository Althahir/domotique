<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contrôle - Pièce</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="shortcut icon" href="../../backend/assets/logo.png">
  <style>
    :root {
      --accent: #ff6600;
      --bg-dark: #0a0a0d;
      /* Variables pour la nouvelle cohérence des styles */
      --glass-bg-light: rgba(235, 233, 233, 0.9); /* Nouveau fond pour le conteneur */
      --glass-bg-dark: #0a0a0dad; /* Nouveau fond pour les tuiles sombres */
      --glass-border: rgba(255, 255, 255, 0.2);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-dark);
      color: white;
      margin: 0;
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow-x: hidden; /* Assurez-vous que le fond ne cause pas de scroll horizontal */
      min-height: 100vh;
    }

    /* ----- FOND ANIMÉ (Mis à jour avec les nouveaux styles) ----- */
    .background {
      position: fixed; /* Mieux pour un fond plein écran */
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      overflow: hidden;
    }

    .light {
      position: absolute;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      /* background géré par les classes JS */
      filter: blur(5px); /* Ajusté pour cohérence */
      opacity: 0.8;
      animation: moveLight 14s infinite ease-in-out; 
    }

    /* Classes de couleur pour les lumières (ajoutées) */
    .light-color-1 {
        background: radial-gradient(circle, #ff6600, transparent 70%); 
    }
    .light-color-2 {
        background: radial-gradient(circle, #ff8800, transparent 70%); 
    }
    .light-color-3 {
        background: radial-gradient(circle, #ffaa00, transparent 70%); 
    }
    .light-color-4 {
        background: radial-gradient(circle, #ff3300, transparent 70%); 
    }

    @keyframes moveLight {
      0% { transform: translate(0, 0); }
      25% { transform: translate(150px, -100px); }
      50% { transform: translate(-120px, 150px); }
      75% { transform: translate(90px, 70px); }
      100% { transform: translate(0, 0); }
    }
    /* colorShift supprimé, géré par JS/classes */

    /* ----- CONTAINER (Mis à jour avec le nouveau style light) ----- */
    .container {
        width: 90%;
        max-width: 1200px;
        background: var(--glass-bg-light); /* Nouveau fond clair */
        color: var(--bg-dark); /* Texte devient sombre sur fond clair */
        border-radius: 20px;
        padding: 40px;
        backdrop-filter: blur(20px) saturate(150%);
        -webkit-backdrop-filter: blur(20px) saturate(150%);
        box-shadow:
            0 4px 15px rgba(0, 0, 0, 0.4), 
            inset 0 0 0 1px rgba(255, 255, 255, 0.1); 
        border: 1px solid rgba(255, 255, 255, 0.2); 
        z-index: 1;
    }

    h1 {
      color: var(--accent);
      text-align: center;
      margin-bottom: 40px;
      font-size: 2.5em;
      text-shadow: 0 0 25px rgba(255, 102, 0, 0.6);
    }

    h2 {
      color: var(--bg-dark); /* Reste sombre */
      font-size: 1.6em;
      margin-top: 40px;
      margin-bottom: 15px;
      border-left: 4px solid var(--accent);
      padding-left: 10px;
    }

    .device-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
      justify-content: center;
      margin-bottom: 40px;
    }

    /* ----- CARTE DE CONTRÔLE (Mis à jour avec le nouveau style dark) ----- */
    .control-tile {
        width: 230px;
        height: 150px;
        border-radius: 20px;
        
        /* Nouveau style de tuile sombre */
        background: var(--glass-bg-dark); 
        backdrop-filter: blur(10px);
        box-shadow:
            0 4px 8px rgba(0, 0, 0, 0.3),
            inset 0 0 0 1px rgba(255, 255, 255, 0.1); 
        border: 1px solid rgba(255, 255, 255, 0.2);

        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white; /* Reste blanc sur tuile sombre */
        font-weight: 600;
        text-align: center;
        transition: all 0.3s ease-in-out;
    }

    .control-tile:hover {
        transform: scale(1.05); /* Échelle plus prononcée comme les autres tuiles */
        /* background: var(--accent);  */
        box-shadow:
            0 8px 20px rgba(0, 0, 0, 0.6), 
            0 0 30px rgba(255, 102, 0, 0.5); 
        border-color: rgba(255, 255, 255, 0.3);
        color: white;
    }

    .control-tile i {
      font-size: 2.8em;
      margin-bottom: 8px;
      color: white; /* Icône orange par défaut */
      transition: color 0.3s;
    }

    .control-tile:hover i {
      color: white; /* Icône blanche au survol sur fond orange */
    }

    .clim-buttons {
      display: flex;
      justify-content: space-around;
      width: 100%;
      margin-top: 10px;
    }

    .clim-buttons div {
      flex: 1;
      text-align: center;
      cursor: pointer;
      font-size: 0.85em;
      padding: 4px 0;
      border-radius: 6px;
      transition: background-color 0.2s;
      color: white; /* Texte des boutons clim toujours blanc */
    }

    .clim-buttons div:hover {
      background-color: rgba(255, 255, 255, 0.25);
    }

    /* ----- ÉTATS DES APPAREILS (Ajusté pour le fond dark) ----- */
    .light-on, .store-open, .clim-heat, .clim-cool {
      color: white !important;
      background: var(--accent); /* Devient orange ON/HEAT */
      box-shadow:
        0 0 25px rgba(255, 102, 0, 0.8),
        inset 0 0 15px rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .light-off, .store-closed, .clim-off {
      background: var(--glass-bg-dark); /* Reste sur le fond sombre de la tuile */
      opacity: 1;
      color: white;
      box-shadow:
        0 4px 8px rgba(0, 0, 0, 0.3),
        inset 0 0 0 1px rgba(255, 255, 255, 0.1); 
    }
    
    .clim-cool {
      background: rgba(52, 152, 219, 0.9);
      box-shadow:
        0 0 25px rgba(52, 152, 219, 0.8),
        inset 0 0 15px rgba(255, 255, 255, 0.2);
    }

    .light-on i,
    .store-open i,
    .clim-heat i,
    .clim-cool i{
      color: white !important; /* Force l'icône en blanc quand l'appareil est ON/ACTIF */
    }

    .light-off i,
    .store-closed i,
    .clim-off i{
      color: white !important; /* Rétablit l'icône en orange quand OFF/INACTIF */
    }

    /* ----- BOUTON RETOUR (Mis à jour avec Glassmorphism) ----- */
    .back-button {
        display: inline-block;
        margin-top: 20px;
        padding: 10px 20px;
        
        /* Style Glassmorphism pour le bouton */
        background: rgba(255, 255, 255, 0.08);
        color:var(--bg-dark);
        text-decoration: none;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow:
            0 4px 8px rgba(0, 0, 0, 0.3),
            inset 0 0 0 1px rgba(255, 255, 255, 0.1);

        transition: all 0.3s ease-in-out;
        z-index: 10;
    }

    .back-button:hover {
        transform: scale(1.05); /* Plus prononcé */
        background: rgba(255, 255, 255, 0.15);
        color: var(--accent); 
        box-shadow:
            0 6px 12px rgba(0, 0, 0, 0.5),
            0 0 15px var(--accent); /* Ajout d'une lueur accentuée */
    }

  </style>
</head>

<body>
    <div class="background">
        <div class="light" style="top:5%; left:10%; animation-delay:0s;"></div> 
        <div class="light" style="top:25%; left:60%; animation-delay:1s;"></div>
        <div class="light" style="top:65%; left:30%; animation-delay:1.25s;"></div>
        <div class="light" style="top:80%; left:80%; animation-delay:1.5s;"></div>
        <div class="light" style="top:10%; left:80%; animation-delay:1.75s;"></div>
        <div class="light" style="top:50%; left:90%; animation-delay:2s;"></div>
        <div class="light" style="top:70%; left:5%; animation-delay:2.25s;"></div>
        <div class="light" style="top:85%; left:40%; animation-delay:2.5s;"></div>
        <div class="light" style="top:40%; left:20%; animation-delay:2.75s;"></div>
        <div class="light" style="top:15%; left:45%; animation-delay:3s;"></div>
        <div class="light" style="top:55%; left:75%; animation-delay:3.25s;"></div>
        <div class="light" style="top:90%; left:15%; animation-delay:3.5s;"></div>

        <div class="light" style="top:30%; left:5%; animation-delay:3.75s;"></div>
        <div class="light" style="top:5%; left:50%; animation-delay:4s;"></div>
        <div class="light" style="top:45%; left:95%; animation-delay:4.25s;"></div>
        <div class="light" style="top:75%; left:70%; animation-delay:4.5s;"></div>
        <div class="light" style="top:20%; left:30%; animation-delay:4.75s;"></div>
        <div class="light" style="top:60%; left:15%; animation-delay:5s;"></div>
        <!-- <div class="light" style="top:50%; left:40%; animation-delay:5.25s;"></div>
        <div class="light" style="top:95%; left:60%; animation-delay:5.5s;"></div>
        <div class="light" style="top:35%; left:85%; animation-delay:5.75s;"></div>
        <div class="light" style="top:80%; left:10%; animation-delay:6s;"></div>
        <div class="light" style="top:10%; left:65%; animation-delay:6.25s;"></div>
        <div class="light" style="top:70%; left:45%; animation-delay:6.5s;"></div>
        
        <div class="light" style="top:15%; left:5%; animation-delay:6.75s;"></div>
        <div class="light" style="top:80%; left:25%; animation-delay:7s;"></div>
        <div class="light" style="top:55%; left:10%; animation-delay:7.25s;"></div>
        <div class="light" style="top:20%; left:90%; animation-delay:7.5s;"></div>
        <div class="light" style="top:75%; left:95%; animation-delay:7.75s;"></div>
        <div class="light" style="top:30%; left:70%; animation-delay:8s;"></div>
        <div class="light" style="top:90%; left:75%; animation-delay:8.25s;"></div>
        <div class="light" style="top:60%; left:55%; animation-delay:8.5s;"></div>
        <div class="light" style="top:5%; left:30%; animation-delay:8.75s;"></div>
        <div class="light" style="top:45%; left:65%; animation-delay:9s;"></div>
        <div class="light" style="top:95%; left:5%; animation-delay:9.25s;"></div>
        <div class="light" style="top:65%; left:85%; animation-delay:9.5s;"></div> -->
  </div>

  <div class="container">
    <h1 id="page-title"><i class="fa-solid fa-house"></i> Contrôle de la Pièce</h1>
    <div id="controls-container"></div>
    <a href="./dashboard.html" class="back-button"><i class="fa-solid fa-arrow-left"></i> Retour aux Pièces</a>
  </div>

  <script>
        // CODE JAVASCRIPT POUR L'ATTRIBUTION ALÉATOIRE DES COULEURS
        document.addEventListener('DOMContentLoaded', () => {
            const lights = document.querySelectorAll('.light');
            const numColors = 4;

            lights.forEach(light => {
                const randomColorIndex = Math.floor(Math.random() * numColors) + 1; 
                light.classList.add(`light-color-${randomColorIndex}`);
            });
        });


    /* Ton script JavaScript d'origine pour la logique des appareils */
    const DEVICE_TYPES = {
      lamps: { title: "Lumières", icon: "fa-lightbulb" },
      store: { title: "Volets Roulants", icon: "fa-house-chimney-window" },
      clim: { title: "Climatisation révérsible", icon: "fa-snowflake" }
    };

    const urlParams = new URLSearchParams(window.location.search);
    const rawRoomName = urlParams.get('room')?.trim() || '';

    function normalizeName(name) {
      return name.toLowerCase()
        .replace(/_/g, ' ')
        .replace(/-/g, ' ')
        .replace(/\s+/g, '')
        .normalize("NFD").replace(/[\u0300-\u036f]/g, '');
    }

    const normalizedRoom = normalizeName(rawRoomName);
    document.title = `Contrôle - ${rawRoomName}`;
    document.getElementById("page-title").innerHTML = `<i class="fa-solid fa-house"></i> Contrôle de ${rawRoomName}`;

    async function loadDevices() {
      try {
        const response = await fetch("../../backend/data/devices.json");
        if (!response.ok) throw new Error("Erreur de chargement du JSON");
        const data = await response.json();
        return data;
      } catch (err) {
        console.error("❌ Erreur chargement JSON :", err);
        return {};
      }
    }

    let DEVICES_JSON_DATA = {};

    document.addEventListener("DOMContentLoaded", async () => {
      DEVICES_JSON_DATA = await loadDevices();
      generateControls();
    });

    function generateControls() {
      const container = document.getElementById('controls-container');
      container.innerHTML = '';

      if (!rawRoomName) {
        container.innerHTML = "<p>⚠️ Aucune pièce spécifiée dans l’URL.</p>";
        return;
      }

      for (const typeKey in DEVICES_JSON_DATA) {
        const typeInfo = DEVICE_TYPES[typeKey];
        const devices = DEVICES_JSON_DATA[typeKey];
        if (!typeInfo || !devices) continue;

        const deviceNames = Object.keys(devices).filter(deviceName => {
          const deviceRoom = deviceName.split(' - ')[0];
          const normalizedDevice = normalizeName(deviceRoom);

          if (normalizedRoom === 'chambrene') {
            return (normalizedDevice === 'chambrene' || normalizedDevice === 'chambrenordest');
          }
          if (normalizedRoom === 'chambreso') {
            return (normalizedDevice === 'chambreso' || normalizedDevice === 'chambresudouest');
          }
          return normalizedDevice === normalizedRoom;
        });

        if (deviceNames.length === 0) continue;

        const h2 = document.createElement('h2');
        h2.innerHTML = `${typeInfo.title}`;
        container.appendChild(h2);

        const grid = document.createElement('div');
        grid.className = 'device-grid';

        deviceNames.forEach(deviceName => {
          const deviceData = devices[deviceName];
          const tile = createDeviceTile(typeKey, typeInfo, deviceName, deviceData);
          grid.appendChild(tile);
        });

        container.appendChild(grid);
        container.appendChild(document.createElement('hr'));
      }

      const hrs = container.querySelectorAll('hr');
      if (hrs.length > 0) container.removeChild(hrs[hrs.length - 1]);
    }

    function createDeviceTile(typeKey, typeInfo, deviceName, deviceData) {
      const tile = document.createElement('div');
      const shortName = deviceName.split(' - ')[1] || deviceName;

      if (typeKey === 'clim') {
        const initialClass = getClimClass(deviceData.mode, deviceData.state);
        tile.className = `control-tile ${initialClass}`;
        tile.innerHTML = `<i class="fa-solid ${typeInfo.icon}"></i><span>${shortName}</span>`;

        const btnContainer = document.createElement('div');
        btnContainer.className = 'clim-buttons';
        const actions = [
          { label: 'ON', action: 'on' },
          { label: 'OFF', action: 'off' },
          { label: 'CHAUD', action: 'heat' },
          { label: 'FROID', action: 'cool' }
        ];

        actions.forEach(btnInfo => {
          const div = document.createElement('div');
          div.textContent = btnInfo.label;
          div.addEventListener('click', (e) => {
            e.stopPropagation();
            sendClimCommand(deviceName, btnInfo.action, tile);
          });
          btnContainer.appendChild(div);
        });

        tile.appendChild(btnContainer);
        return tile;
      }

      let displayState = getDisplayState(typeKey, deviceData.state);
      let cssClass = getCssClass(typeKey, deviceData.state);

      tile.className = `control-tile ${cssClass}`;
      tile.innerHTML = `<i class="fa-solid ${typeInfo.icon}"></i><span>${shortName} (${displayState})</span>`;

      tile.addEventListener('click', () => {
        const nextAction = deviceData.state === 'ON' ? 'off' : 'on';
        sendDeviceCommand(typeKey, deviceName, nextAction, tile, deviceData);
      });

      return tile;
    }

    function sendDeviceCommand(typeKey, deviceName, action, tile, deviceData) {
      let cgi = (typeKey === 'lamps') ? 'lampe.exe' : 'store.exe';
      const url = `/cgi-bin/${cgi}?device=${encodeURIComponent(deviceName)}&action=${action}`;
      fetch(url)
        .then(r => r.text())
        .then(() => {
          deviceData.state = (action === 'on') ? 'ON' : 'OFF';
          updateTileVisual(tile, typeKey, deviceName, deviceData);
        })
        .catch(err => console.error("❌ Erreur CGI :", err));
    }

    async function sendClimCommand(deviceName, action, tile) {
      const url = `/cgi-bin/clim.exe?device=${encodeURIComponent(deviceName)}&action=${action}`;
      try {
        const response = await fetch(url);
        const updatedData = await loadDevices();
        const climData = updatedData.clim?.[deviceName];
        if (climData) {
          const newClass = getClimClass(climData.mode, climData.state);
          tile.className = `control-tile ${newClass}`;
        }
      } catch (err) {
        console.error("❌ Erreur CLIM :", err);
      }
    }

    function updateTileVisual(tile, typeKey, deviceName, deviceData) {
      const shortName = deviceName.split(' - ')[1] || deviceName;
      const displayState = getDisplayState(typeKey, deviceData.state);
      const cssClass = getCssClass(typeKey, deviceData.state);
      const icon = DEVICE_TYPES[typeKey].icon;
      tile.className = `control-tile ${cssClass}`;
      tile.innerHTML = `<i class="fa-solid ${icon}"></i><span>${shortName} (${displayState})</span>`;
    }

    function getDisplayState(typeKey, state) {
      if (typeKey === 'store') return state === 'ON' ? 'OUVERT' : 'FERMÉ';
      return state;
    }

    function getCssClass(typeKey, state) {
      if (typeKey === 'lamps') return state === 'ON' ? 'light-on' : 'light-off';
      if (typeKey === 'store') return state === 'ON' ? 'store-open' : 'store-closed';
      return '';
    }

    function getClimClass(mode, state) {
      if (state === 'OFF') return 'clim-off';
      if (mode === 1) return 'clim-heat';
      if (mode === 0) return 'clim-cool';
      return 'clim-on';
    }
  </script>
</body>
</html>